name: Build Windows Installer

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 0.29.1)'
        required: false
        default: ''

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    - name: Determine version
      id: version
      shell: bash
      run: |
        if [ -n "${{ github.event.inputs.version }}" ]; then
          VERSION="${{ github.event.inputs.version }}"
        elif [ "${{ github.event_name }}" = "release" ]; then
          # Strip 'v' prefix if present
          VERSION="${GITHUB_REF_NAME#v}"
        else
          VERSION="0.0.0"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        
        # Parse version components and convert to integers to strip leading zeros
        IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
        # Default to 0 if empty, and convert to integer to strip leading zeros
        MAJOR=$((MAJOR + 0))
        MINOR=$((MINOR + 0))
        PATCH=$((PATCH + 0))
        NUMERIC_VERSION="${MAJOR}.${MINOR}.${PATCH}.0"
        echo "NUMERIC_VERSION=$NUMERIC_VERSION" >> $GITHUB_OUTPUT
        echo "MAJOR=$MAJOR" >> $GITHUB_OUTPUT
        echo "MINOR=$MINOR" >> $GITHUB_OUTPUT
        echo "PATCH=$PATCH" >> $GITHUB_OUTPUT
        
        echo "Building version: $VERSION (numeric: $NUMERIC_VERSION)"
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install -e .
        
    - name: Generate version_info.txt
      shell: bash
      run: |
        # Use the pre-parsed integer version components (no leading zeros)
        MAJOR=${{ steps.version.outputs.MAJOR }}
        MINOR=${{ steps.version.outputs.MINOR }}
        PATCH=${{ steps.version.outputs.PATCH }}
        VERSION=${{ steps.version.outputs.VERSION }}
        
        cat > version_info.txt << EOF
        # UTF-8
        #
        # Windows version info file for PyInstaller
        # Auto-generated by CI/CD build.
        #
        VSVersionInfo(
          ffi=FixedFileInfo(
            filevers=(${MAJOR}, ${MINOR}, ${PATCH}, 0),
            prodvers=(${MAJOR}, ${MINOR}, ${PATCH}, 0),
            mask=0x3f,
            flags=0x0,
            OS=0x40004,
            fileType=0x1,
            subtype=0x0,
            date=(0, 0)
          ),
          kids=[
            StringFileInfo([
              StringTable(
                '040904B0',
                [
                  StringStruct('CompanyName', 'Acrotron, Inc.'),
                  StringStruct('FileDescription', 'Aye Chat - Terminal-first AI Code Generator'),
                  StringStruct('FileVersion', '${VERSION}'),
                  StringStruct('InternalName', 'aye'),
                  StringStruct('LegalCopyright', 'Copyright (C) 2024-2025 Acrotron, Inc.'),
                  StringStruct('OriginalFilename', 'aye.exe'),
                  StringStruct('ProductName', 'Aye Chat'),
                  StringStruct('ProductVersion', '${VERSION}'),
                ]
              )
            ]),
            VarFileInfo([VarStruct('Translation', [1033, 1200])])
          ]
        )
        EOF
        
        echo "Generated version_info.txt:"
        cat version_info.txt
        
    - name: Generate frozen version module
      shell: bash
      run: |
        VERSION=${{ steps.version.outputs.VERSION }}
        mkdir -p src/aye
        echo "__version__ = '${VERSION}'" > src/aye/_frozen_version.py
        echo "Generated _frozen_version.py with version: ${VERSION}"
        
    - name: Build with PyInstaller
      run: |
        pyinstaller aye-chat.spec --noconfirm
        
    - name: Verify build
      run: |
        .\dist\aye-chat\aye.exe --version
        
    - name: Install Inno Setup
      run: |
        choco install innosetup -y
        
    - name: Build installer
      run: |
        $env:PATH += ";C:\Program Files (x86)\Inno Setup 6"
        iscc installer.iss /DMyAppVersion=${{ steps.version.outputs.VERSION }} /DMyAppNumericVersion=${{ steps.version.outputs.NUMERIC_VERSION }}
        
    - name: Upload installer artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-installer
        path: Output/*.exe
        
    - name: Upload to release
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: Output/*.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
