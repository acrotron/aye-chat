name: Test Nix Installation

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to test (default: dev-nix)'
        required: false
        default: 'dev-nix'
  push:
    branches:
      - dev-nix
      
jobs:
  test-github-install:
    runs-on: ubuntu-latest
    steps:
      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Test nix run from GitHub
        run: |
          nix run github:acrotron/aye-chat/${{ github.event.inputs.branch || 'dev-nix' }} -- --version

      - name: Test nix profile install from GitHub
        run: |
          nix profile install github:acrotron/aye-chat/${{ github.event.inputs.branch || 'dev-nix' }}
          aye --version

          # List all installed packages
          echo "Installed packages:"
          nix profile list

          # Find and remove the installed package by name
          # nix profile list output format (newer nix versions):
          # Name:               aye-chat
          # Flake attribute:    ...
          # The package name can be used directly with nix profile remove
          PACKAGE_NAME=$(nix profile list | grep -E '^Name:' | awk '{print $2}' | grep -E 'aye-chat|ayechat' | head -1)
          echo "Found package name: '$PACKAGE_NAME'"

          if [ -n "$PACKAGE_NAME" ]; then
            nix profile remove "$PACKAGE_NAME"
            echo "Package removed successfully"
          else
            echo "Could not find package name, trying alternative removal..."
            # Try removing by common names
            nix profile remove "aye-chat" 2>/dev/null || \
            nix profile remove "ayechat" 2>/dev/null || \
            echo "Warning: Could not remove package, but installation test passed"
          fi